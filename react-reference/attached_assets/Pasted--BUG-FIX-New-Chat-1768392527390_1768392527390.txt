================================================================================
BUG FIX: "New Chat" Button Not Properly Resetting Session State
================================================================================

ISSUE OBSERVED:
---------------
1. User sends message in Chat A: "list my categories"
2. Chat A returns: Table with 101 categories
3. User clicks "New Chat" button
4. User sends message in Chat B: "show me top 5 customers"
5. BUG: Chat B displays Chat A's response (categories table) + new message

The previous chat's response is bleeding into the new chat.

ROOT CAUSE ANALYSIS:
--------------------
The "New Chat" button is not properly resetting one or more of:
1. The messages array in React state
2. The session_id being sent to the WebSocket
3. The pending/streaming response state

LIKELY LOCATION:
----------------
Check these files (based on typical React patterns):
- src/services/labeeb-api.ts (WebSocket client)
- src/services/session-storage.ts (Session management)
- The component that handles "New Chat" button click

WHAT TO FIX:
------------

1. FIND the "New Chat" button click handler. It likely does something like:

   const handleNewChat = () => {
     setMessages([]);  // Clears messages
     // BUT: Missing session_id reset!
   }

2. THE FIX should ensure ALL of these are reset:

   const handleNewChat = () => {
     // Clear message history
     setMessages([]);

     // Generate NEW session_id (critical!)
     const newSessionId = `session-${crypto.randomUUID()}`;
     setSessionId(newSessionId);

     // Clear URL query param
     window.history.replaceState({}, '', '/ai-orbit/assistant');

     // Reset any streaming/pending state
     setIsStreaming(false);
     setPendingResponse(null);
     setStructuredResponse(null);  // <-- This might be the culprit!

     // Reset any pending HITL state
     setPendingApproval(null);
   };

3. CHECK for stale state in the message rendering component:

   - If there's a `structuredResponse` state that persists across chats
   - If there's a `lastResponse` cache that isn't cleared
   - If messages are being read from localStorage/sessionStorage incorrectly

4. CHECK the WebSocket message handler:

   When receiving messages, verify the session_id matches current session:

   ws.onmessage = (event) => {
     const data = JSON.parse(event.data);

     // IMPORTANT: Ignore messages from old sessions
     if (data.session_id && data.session_id !== currentSessionId) {
       console.warn('Ignoring message from old session:', data.session_id);
       return;
     }

     // Process message...
   };

5. CHECK for race conditions:

   If user clicks "New Chat" while a response is still streaming:
   - The old response might complete and render after state was "cleared"
   - Solution: Use an AbortController or session_id check to ignore late responses

DEBUGGING STEPS:
----------------
1. Add console.log to "New Chat" handler:
   console.log('New Chat clicked, clearing session:', currentSessionId);

2. Add console.log when setting messages:
   console.log('Setting messages for session:', sessionId, messages);

3. Check what session_id is being sent with new messages:
   console.log('Sending message with session_id:', sessionId);

4. In WebSocket onmessage, log incoming session_ids:
   console.log('Received message for session:', data.session_id);

TEST AFTER FIX:
---------------
1. Start fresh, send "list my categories" - should show table
2. Click "New Chat"
3. Send "hello" - should show simple text response, NOT the categories table
4. Verify URL changes from ?session_id=old to no session_id (or new one)
5. Verify console shows different session_ids for each chat

ADDITIONAL NOTES:
-----------------
The console log showed: "sendMessage - prev messages: 0 new total: 2"
This suggests:
- prev messages: 0 (correct - new chat should have no previous messages)
- new total: 2 (WRONG - should be 1 for just the new message)

The "2" suggests the welcome message is counted, OR there's some leftover state.

Also check: Is the welcome message ("Hello! I'm your AI assistant...") being
added to the messages array? If so, ensure it's a fresh object, not a reference
to a previous message.
================================================================================
