REPLIT FRONTEND: Query Clarification Modal
==========================================

When user asks for large data (e.g., "list all my products"), backend pauses
and sends a clarification request. User can either refine their query or
proceed with the full data fetch.

================================================================
WEBSOCKET MESSAGES
================================================================

SERVER -> CLIENT (New message type):
{
  "type": "query_clarification",
  "session_id": "xxx",
  "tool_name": "Foodics___search_products",
  "message": "This query may return a large dataset. Would you like to refine?",
  "suggested_filters": [
    {"name": "category", "description": "Filter by product category"},
    {"name": "status", "description": "Filter by active/inactive status"},
    {"name": "limit", "description": "Limit number of results"}
  ],
  "arguments": {}
}

CLIENT -> SERVER (User proceeds):
{
  "type": "clarification_response",
  "session_id": "xxx",
  "action": "proceed"
}

CLIENT -> SERVER (User refines):
{
  "type": "clarification_response",
  "session_id": "xxx",
  "action": "refine",
  "refinement": "only active products in burgers category, limit 20"
}

SERVER -> CLIENT (Acknowledgment):
{
  "type": "clarification_ack",
  "session_id": "xxx",
  "action": "proceed" | "refine"
}

================================================================
STEP 1: ADD STATE
================================================================

// In your chat component state
const [queryClarification, setQueryClarification] = useState<{
  isOpen: boolean;
  sessionId: string;
  toolName: string;
  message: string;
  suggestedFilters: Array<{name: string; description: string}>;
} | null>(null);

================================================================
STEP 2: UPDATE WEBSOCKET HANDLER
================================================================

case 'query_clarification':
  console.log('[WS] Query clarification:', data);
  setQueryClarification({
    isOpen: true,
    sessionId: data.session_id,
    toolName: data.tool_name,
    message: data.message,
    suggestedFilters: data.suggested_filters || [],
  });
  // Hide spinner - we're waiting for user input
  setIsLoading(false);
  break;

case 'clarification_ack':
  console.log('[WS] Clarification acknowledged:', data.action);
  // Show spinner again - processing user's choice
  setIsLoading(true);
  break;

================================================================
STEP 3: CREATE MODAL COMPONENT
================================================================

interface QueryClarificationModalProps {
  isOpen: boolean;
  sessionId: string;
  toolName: string;
  message: string;
  suggestedFilters: Array<{name: string; description: string}>;
  onProceed: () => void;
  onRefine: (refinement: string) => void;
  onCancel: () => void;
}

const QueryClarificationModal: React.FC<QueryClarificationModalProps> = ({
  isOpen,
  sessionId,
  toolName,
  message,
  suggestedFilters,
  onProceed,
  onRefine,
  onCancel,
}) => {
  const [refinement, setRefinement] = useState('');

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4 shadow-xl">
        {/* Header */}
        <div className="flex items-center gap-3 mb-4">
          <div className="w-10 h-10 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center">
            <span className="text-xl">ğŸ“Š</span>
          </div>
          <div>
            <h3 className="font-semibold text-gray-900 dark:text-white">
              Large Dataset Query
            </h3>
            <p className="text-sm text-gray-500 dark:text-gray-400">
              {toolName.replace('Foodics___', '').replace(/_/g, ' ')}
            </p>
          </div>
        </div>

        {/* Message */}
        <p className="text-gray-700 dark:text-gray-300 mb-4">
          {message}
        </p>

        {/* Suggested Filters */}
        {suggestedFilters.length > 0 && (
          <div className="mb-4">
            <p className="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">
              You can filter by:
            </p>
            <ul className="text-sm text-gray-500 dark:text-gray-400 space-y-1">
              {suggestedFilters.map((f) => (
                <li key={f.name}>â€¢ {f.name}: {f.description}</li>
              ))}
            </ul>
          </div>
        )}

        {/* Refinement Input */}
        <div className="mb-4">
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Refine your query (optional):
          </label>
          <textarea
            value={refinement}
            onChange={(e) => setRefinement(e.target.value)}
            placeholder="e.g., only active products, limit to 50, in the burgers category"
            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                       focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            rows={3}
          />
        </div>

        {/* Actions */}
        <div className="flex gap-3">
          <button
            onClick={onCancel}
            className="flex-1 px-4 py-2 text-gray-700 dark:text-gray-300
                       bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200
                       dark:hover:bg-gray-600 transition-colors"
          >
            Cancel
          </button>
          <button
            onClick={onProceed}
            className="flex-1 px-4 py-2 text-white bg-gray-600 rounded-lg
                       hover:bg-gray-700 transition-colors"
          >
            Proceed Anyway
          </button>
          <button
            onClick={() => onRefine(refinement)}
            disabled={!refinement.trim()}
            className="flex-1 px-4 py-2 text-white bg-blue-600 rounded-lg
                       hover:bg-blue-700 transition-colors disabled:opacity-50
                       disabled:cursor-not-allowed"
          >
            Refine Query
          </button>
        </div>
      </div>
    </div>
  );
};

================================================================
STEP 4: ADD MODAL TO CHAT PAGE
================================================================

// In your chat component, add handlers:

const handleClarificationProceed = () => {
  if (!queryClarification) return;

  ws.send(JSON.stringify({
    type: 'clarification_response',
    session_id: queryClarification.sessionId,
    action: 'proceed',
  }));

  setQueryClarification(null);
  setIsLoading(true);
};

const handleClarificationRefine = (refinement: string) => {
  if (!queryClarification) return;

  ws.send(JSON.stringify({
    type: 'clarification_response',
    session_id: queryClarification.sessionId,
    action: 'refine',
    refinement: refinement,
  }));

  setQueryClarification(null);
  setIsLoading(true);
};

const handleClarificationCancel = () => {
  // Cancel just closes modal without sending response
  // User will need to send a new message
  setQueryClarification(null);
};

// Add modal to JSX:
{queryClarification && (
  <QueryClarificationModal
    isOpen={queryClarification.isOpen}
    sessionId={queryClarification.sessionId}
    toolName={queryClarification.toolName}
    message={queryClarification.message}
    suggestedFilters={queryClarification.suggestedFilters}
    onProceed={handleClarificationProceed}
    onRefine={handleClarificationRefine}
    onCancel={handleClarificationCancel}
  />
)}

================================================================
TEST
================================================================

Queries that trigger clarification:
- "list all my products"
- "show me all customers"
- "list categories"
- "search products"

Expected flow:
1. User sends "list all my products"
2. Modal appears with refinement option
3. User clicks "Proceed Anyway" -> full data returned
4. OR User types "only active, limit 20" and clicks "Refine Query" -> filtered data returned

================================================================
VISUAL MOCKUP
================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š Large Dataset Query                                        â”‚
â”‚     search_products                                             â”‚
â”‚                                                                 â”‚
â”‚  This query may return a large dataset. Would you like to      â”‚
â”‚  refine your search?                                            â”‚
â”‚                                                                 â”‚
â”‚  You can filter by:                                             â”‚
â”‚  â€¢ category: Filter by product category                         â”‚
â”‚  â€¢ status: Filter by active/inactive status                     â”‚
â”‚  â€¢ limit: Limit number of results                               â”‚
â”‚                                                                 â”‚
â”‚  Refine your query (optional):                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ only active products, limit 50                          â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  [ Cancel ]  [ Proceed Anyway ]  [ Refine Query ]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
