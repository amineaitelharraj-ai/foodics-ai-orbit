REPLIT: Query Clarification Modal
==================================

When user asks for large data (e.g., "list all my products"), backend pauses
and shows a clarification modal. User can either refine their query or proceed.

================================================================
WEBSOCKET MESSAGES
================================================================

SERVER -> CLIENT (Show modal):
{
  "type": "query_clarification",
  "session_id": "xxx",
  "tool_name": "Foodics___search_products",
  "message": "I found lots of results! Fetching everything will take a moment. Would you like to narrow it down?",
  "suggested_filters": [
    {"name": "category", "description": "A specific category (e.g., burgers, drinks)"},
    {"name": "status", "description": "Only active or deleted products"},
    {"name": "limit", "description": "Just the top 10, 20, etc."}
  ]
}

CLIENT -> SERVER (User proceeds):
{
  "type": "clarification_response",
  "session_id": "xxx",
  "action": "proceed"
}

CLIENT -> SERVER (User refines):
{
  "type": "clarification_response",
  "session_id": "xxx",
  "action": "refine",
  "refinement": "only active products in burgers category, limit 20"
}

SERVER -> CLIENT (Acknowledgment):
{
  "type": "clarification_ack",
  "session_id": "xxx",
  "action": "proceed" | "refine"
}

SERVER -> CLIENT (Refinement echo - shows user's refinement in chat):
{
  "type": "refinement_applied",
  "session_id": "xxx",
  "refinement": "only active products in burgers category, limit 20",
  "tool_name": "Foodics___search_products"
}

================================================================
IMPLEMENTATION
================================================================

1. ADD STATE:

const [queryClarification, setQueryClarification] = useState<{
  isOpen: boolean;
  sessionId: string;
  toolName: string;
  message: string;
  suggestedFilters: Array<{name: string; description: string}>;
} | null>(null);

2. WEBSOCKET HANDLER - Add these cases:

case 'query_clarification':
  setQueryClarification({
    isOpen: true,
    sessionId: data.session_id,
    toolName: data.tool_name,
    message: data.message,
    suggestedFilters: data.suggested_filters || [],
  });
  setIsLoading(false);
  break;

case 'clarification_ack':
  setIsLoading(true);
  break;

case 'refinement_applied':
  // Show refinement in chat for traceability
  setMessages((prev) => [
    ...prev,
    {
      id: `refinement-${Date.now()}`,
      role: 'user',
      content: data.refinement,
    },
  ]);
  break;

3. MODAL COMPONENT:

const QueryClarificationModal = ({
  isOpen,
  sessionId,
  toolName,
  message,
  suggestedFilters,
  onProceed,
  onRefine,
  onCancel,
}) => {
  const [refinement, setRefinement] = useState('');

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4 shadow-xl">
        {/* Header */}
        <div className="flex items-center gap-3 mb-4">
          <div className="w-10 h-10 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center">
            <span className="text-xl">ğŸ”</span>
          </div>
          <div>
            <h3 className="font-semibold text-gray-900 dark:text-white">
              Quick Question
            </h3>
            <p className="text-sm text-gray-500 dark:text-gray-400">
              {toolName.replace('Foodics___', '').replace(/_/g, ' ')}
            </p>
          </div>
        </div>

        {/* Message */}
        <p className="text-gray-700 dark:text-gray-300 mb-4">{message}</p>

        {/* Suggested Filters */}
        {suggestedFilters.length > 0 && (
          <div className="mb-4">
            <p className="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">
              You can filter by:
            </p>
            <ul className="text-sm text-gray-500 dark:text-gray-400 space-y-1">
              {suggestedFilters.map((f) => (
                <li key={f.name}>â€¢ {f.name}: {f.description}</li>
              ))}
            </ul>
          </div>
        )}

        {/* Refinement Input */}
        <div className="mb-4">
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Refine your query (optional):
          </label>
          <textarea
            value={refinement}
            onChange={(e) => setRefinement(e.target.value)}
            placeholder="e.g., only active products, limit to 50"
            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                       focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            rows={3}
          />
        </div>

        {/* Actions */}
        <div className="flex gap-3">
          <button
            onClick={onCancel}
            className="flex-1 px-4 py-2 text-gray-700 dark:text-gray-300
                       bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200
                       dark:hover:bg-gray-600 transition-colors"
          >
            Cancel
          </button>
          <button
            onClick={onProceed}
            className="flex-1 px-4 py-2 text-white bg-gray-600 rounded-lg
                       hover:bg-gray-700 transition-colors"
          >
            Get All
          </button>
          <button
            onClick={() => onRefine(refinement)}
            disabled={!refinement.trim()}
            className="flex-1 px-4 py-2 text-white bg-blue-600 rounded-lg
                       hover:bg-blue-700 transition-colors disabled:opacity-50
                       disabled:cursor-not-allowed"
          >
            Refine
          </button>
        </div>
      </div>
    </div>
  );
};

4. ADD HANDLERS:

const handleClarificationProceed = () => {
  if (!queryClarification) return;
  ws.send(JSON.stringify({
    type: 'clarification_response',
    session_id: queryClarification.sessionId,
    action: 'proceed',
  }));
  setQueryClarification(null);
  setIsLoading(true);
};

const handleClarificationRefine = (refinement: string) => {
  if (!queryClarification) return;
  ws.send(JSON.stringify({
    type: 'clarification_response',
    session_id: queryClarification.sessionId,
    action: 'refine',
    refinement: refinement,
  }));
  setQueryClarification(null);
  setIsLoading(true);
};

const handleClarificationCancel = () => {
  setQueryClarification(null);
};

5. ADD MODAL TO JSX:

{queryClarification && (
  <QueryClarificationModal
    isOpen={queryClarification.isOpen}
    sessionId={queryClarification.sessionId}
    toolName={queryClarification.toolName}
    message={queryClarification.message}
    suggestedFilters={queryClarification.suggestedFilters}
    onProceed={handleClarificationProceed}
    onRefine={handleClarificationRefine}
    onCancel={handleClarificationCancel}
  />
)}

================================================================
TEST
================================================================

Send: "list all my products"

Expected flow:
1. Modal appears: "I found lots of results! Fetching everything will take a moment..."
2. User types "only active, limit 10" and clicks "Refine"
3. Chat shows user's refinement text
4. Response shows filtered products

================================================================
VISUAL MOCKUP
================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” Quick Question                                              â”‚
â”‚     search products                                             â”‚
â”‚                                                                 â”‚
â”‚  I found lots of results! Fetching everything will take a      â”‚
â”‚  moment. Would you like to narrow it down?                      â”‚
â”‚                                                                 â”‚
â”‚  You can filter by:                                             â”‚
â”‚  â€¢ category: A specific category (e.g., burgers, drinks)       â”‚
â”‚  â€¢ status: Only active or deleted products                      â”‚
â”‚  â€¢ limit: Just the top 10, 20, etc.                             â”‚
â”‚                                                                 â”‚
â”‚  Refine your query (optional):                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ only active products, limit 50                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  [ Cancel ]  [ Get All ]  [ Refine ]                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
